<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
 
 <title>The blog of Ilya Pimenov</title>
 <link href="http://ilyapimenov.com/atom.xml" rel="self"/>
 <link href="http://ilyapimenov.com"/>
 <updated>2014-11-05T10:35:58+01:00</updated>
 <id>http://ilyapimenov.com</id>
 <author>
   <name>Ilya Pimenov</name>
   <email>ilya.pimenov@gmail.com</email>
 </author>

 
 <entry>
   <title>Lua scripts in Redis within Node.js</title>
   <link href="http://ilyapimenov.com/blog/2014/09/19/lua-scripts-in-redis-within-nodejs.html"/>
   <updated>2014-09-19T00:00:00+02:00</updated>
   <id>http://ilyapimenov.com/blog/2014/09/19/lua-scripts-in-redis-within-nodejs</id>
   <content type="html">
&lt;p&gt;We don’t need to tell you what Redis is. Most engineers built a strong love to it over the years for the simplicity and power it gives you.&lt;/p&gt;

&lt;p&gt;Although Lua support was introduced quite some time ago, the average internet tells us that it didn’t really kick off.&lt;/p&gt;

&lt;p&gt;Here we share our experience with replacing part of the server side written in Node.JS with the Lua being executed in Redis,&lt;/p&gt;

&lt;h2 id=&quot;why&quot;&gt;Why&lt;/h2&gt;

&lt;p&gt;So, we have this awesome product Bidder, that plays on the add market exchange. And in order to have all nodes notified of current situation, we use Redis database to share the current state, amount of money available to a particular operation among all the bidders running in the cloud.&lt;/p&gt;

&lt;p&gt;This data structure is rather complex and dependent on each other. For example, consider it to be a tree of nodes, where each branch eats cookies&lt;/p&gt;

&lt;p&gt;Like so:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;a &lt;span class='o'&gt;[&lt;/span&gt; ate: 0 &lt;span class='o'&gt;]&lt;/span&gt;
|--- ab &lt;span class='o'&gt;[&lt;/span&gt; ate: 0 &lt;span class='o'&gt;]&lt;/span&gt;
      |--- abe &lt;span class='o'&gt;[&lt;/span&gt; ate: 0 &lt;span class='o'&gt;]&lt;/span&gt;
      |--- abi &lt;span class='o'&gt;[&lt;/span&gt; ate: 0 &lt;span class='o'&gt;]&lt;/span&gt;
|--- ac &lt;span class='o'&gt;[&lt;/span&gt; ate: 0 &lt;span class='o'&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So, if the branch &lt;code&gt;abe&lt;/code&gt; ate 2 cookies, &lt;code&gt;a&lt;/code&gt; should have a balance of two eaten cookies — &lt;code&gt;a [ ate: 2 ]&lt;/code&gt;. And then if &lt;code&gt;abi&lt;/code&gt; eats &lt;code&gt;3&lt;/code&gt; and &lt;code&gt;ac&lt;/code&gt; eats &lt;code&gt;1&lt;/code&gt;, then it should go like:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;a &lt;span class='o'&gt;[&lt;/span&gt; ate: &lt;span class='nv'&gt;6&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; 0 + 2 + 3 + 1 &lt;span class='o'&gt;]&lt;/span&gt;
|--- ab &lt;span class='o'&gt;[&lt;/span&gt; ate: &lt;span class='nv'&gt;5&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; 0 + 2 + 3 &lt;span class='o'&gt;]&lt;/span&gt;
      |--- abe &lt;span class='o'&gt;[&lt;/span&gt; ate: &lt;span class='nv'&gt;2&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; 0 + 2 &lt;span class='o'&gt;]&lt;/span&gt;
      |--- abi &lt;span class='o'&gt;[&lt;/span&gt; ate: &lt;span class='nv'&gt;3&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; 0 + 3 &lt;span class='o'&gt;]&lt;/span&gt;
|--- ac &lt;span class='o'&gt;[&lt;/span&gt; ate: &lt;span class='nv'&gt;1&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; 0 + 1 &lt;span class='o'&gt;]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So, previously we would have this big script in NodeJS that will batch all outgoing operations, and respectively update all nodes of the bank, this would be done from a single machine, called &lt;code&gt;Bank&lt;/code&gt;. All other machines would connect to it through a &lt;code&gt;BankClient&lt;/code&gt; — basically EventEmitter that talks to a &lt;code&gt;Bank&lt;/code&gt; service. In this architecture you cannot have two Bank machines, as you would’ve run into concurrency issues that way. There are transactions in Redis, but when you have to combine them together with business logic, it gets rather messy as you cannot simply rollback.&lt;/p&gt;

&lt;p&gt;But most importantly of all, this is ultimately not scalable and you have to maintain a lot of synchronization code in NodeJS to interact with your bank’s persistence.&lt;/p&gt;

&lt;h2 id=&quot;solution&quot;&gt;Solution&lt;/h2&gt;

&lt;p&gt;An absolute win in this case is to incorporate all your logic into Redis. Think about it — you have one single threaded database that performs your business logic requests in an atomic way. And later on you can shard it, by the main key of each data structure being stored. It doesn’t really get any easier than this.&lt;/p&gt;

&lt;p&gt;Basically, it’s not a database any longer, it is a persistence container, and you deploy your accounting business logic into it.&lt;/p&gt;

&lt;h2 id=&quot;how&quot;&gt;How&lt;/h2&gt;

&lt;p&gt;Now, how do you do this with Redis? By utilizing the &lt;code&gt;EVAL&lt;/code&gt; command — http://redis.io/commands/EVAL. It enables you to run Lua scripts inside your Redis instance.&lt;/p&gt;

&lt;p&gt;Now, a lot of people might get sceptical once they hear Lua. Another language, another platform, all the burden of maintenance and testing issues.&lt;/p&gt;

&lt;p&gt;What we aim to show here — is that all those are addressed in rather classical fashion, by unit-tests and integration tests, and you will find the approach of running Lua on top of Redis surprisingly pleasing.&lt;/p&gt;

&lt;h2 id=&quot;getting_all_together&quot;&gt;Getting all together&lt;/h2&gt;

&lt;p&gt;Let’s put it all together. We will try to address task stated in Why section of this article: a tree-like structure that propagates it changes to all the parent nodes.&lt;/p&gt;

&lt;p&gt;First things first — you need to get Lua running locally on your machine in order to run Lua scripts as you are developing them.&lt;/p&gt;

&lt;p&gt;I recommend you to install &lt;code&gt;luarocks&lt;/code&gt;, a Lua-packet manager (what &lt;code&gt;npm&lt;/code&gt; is to NodeJS, &lt;code&gt;cocoapods&lt;/code&gt; are to Objective C, &lt;code&gt;mvn&lt;/code&gt; to Java, &lt;code&gt;leiningen&lt;/code&gt; to Clojure). With &lt;code&gt;brew&lt;/code&gt; on Mac:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='nv'&gt;$ &lt;/span&gt;brew install luarocks
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;One thing to keep in mind, is that together with Lua runtime you will require a bunch of auxiliary libraries that are installed in Redis, in order to be able to write good, full blown scripts.&lt;/p&gt;

&lt;p&gt;A quick note on the data format we use in Redis. Since most of our data structures are rather complex and require a set parameters on different levels, we utilize JSON in our Redis values.&lt;/p&gt;

&lt;p&gt;The only third party libraries, not native to Lua are &lt;code&gt;struct&lt;/code&gt;, &lt;code&gt;CJSON&lt;/code&gt; and &lt;code&gt;cmsgpack&lt;/code&gt;, as can be seen in &lt;a href=&quot;http://redis.io/commands/EVAL&quot;&gt;EVAL spec&lt;/a&gt;. With &lt;code&gt;luarocks&lt;/code&gt; it is a no-brainer:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='nv'&gt;$ &lt;/span&gt;luarocks install lua-cjson
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we are good to write our first Lua script!&lt;/p&gt;

&lt;h3 id=&quot;update_the_node_and_all_parent_nodes&quot;&gt;Update the node and all parent nodes&lt;/h3&gt;

&lt;p&gt;In our sample task we will update the node and all it parent nodes. Nodes are keys in Redis that are composed of its parent names and its own name all dot separated.&lt;/p&gt;

&lt;p&gt;So, if you have a node &lt;code&gt;a.b.c&lt;/code&gt; and you want to persist &lt;code&gt;{spent: 5}&lt;/code&gt; with the key &lt;code&gt;a.b.c&lt;/code&gt;, the &lt;code&gt;spent&lt;/code&gt; amount in both keys &lt;code&gt;a&lt;/code&gt; and &lt;code&gt;a.b&lt;/code&gt; should also go up.&lt;/p&gt;

&lt;p&gt;The basic approach to it will be —&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='lua'&gt;&lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='o'&gt;#&lt;/span&gt;&lt;span class='n'&gt;ARGV&lt;/span&gt; &lt;span class='o'&gt;~=&lt;/span&gt; &lt;span class='mi'&gt;1&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
    &lt;span class='nb'&gt;error&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;your script: there&lt;/span&gt;&lt;span class='se'&gt;\&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;s something fishy here, me not like this&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='k'&gt;end&lt;/span&gt;

&lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='o'&gt;#&lt;/span&gt;&lt;span class='n'&gt;KEYS&lt;/span&gt; &lt;span class='o'&gt;~=&lt;/span&gt; &lt;span class='mi'&gt;1&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
    &lt;span class='nb'&gt;error&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;your script: invalid inputs, one key at a time&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='k'&gt;end&lt;/span&gt;

&lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;spent&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='nb'&gt;tonumber&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;ARGV&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;])&lt;/span&gt;

&lt;span class='c1'&gt;-- This node will give you parent node. Supposedly if there is a key &lt;/span&gt;
&lt;span class='c1'&gt;-- nodeOne.nodeTwo.nodeTree, then nodeTwo is a direct parent of&lt;/span&gt;
&lt;span class='c1'&gt;--  nodeThree; and nodeOne is an indirect parent to nodeThree&lt;/span&gt;
&lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;parent&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='k'&gt;function&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;account&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='c1'&gt;-- searches from the end of the string instead&lt;/span&gt;
    &lt;span class='c1'&gt;-- of the beginning, as string.find does&lt;/span&gt;
    &lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;i&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;account&lt;/span&gt;&lt;span class='p'&gt;:&lt;/span&gt;&lt;span class='n'&gt;match&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;^.*()%.&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;i&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
        &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='nb'&gt;string.sub&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;account&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='mi'&gt;0&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;i&lt;/span&gt; &lt;span class='o'&gt;-&lt;/span&gt; &lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='k'&gt;end&lt;/span&gt;
    &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='kc'&gt;nil&lt;/span&gt;
&lt;span class='k'&gt;end&lt;/span&gt;

&lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;spend&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='kc'&gt;nil&lt;/span&gt; &lt;span class='c1'&gt;-- in order to reference to itself in a recursive way&lt;/span&gt;
&lt;span class='n'&gt;spend&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='k'&gt;function&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;key&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;amount&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;node&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;redis&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;call&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;GET&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;key&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='ow'&gt;not&lt;/span&gt; &lt;span class='n'&gt;node&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
        &lt;span class='nb'&gt;error&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;your script: key &amp;#39;&lt;/span&gt; &lt;span class='o'&gt;..&lt;/span&gt; &lt;span class='n'&gt;key&lt;/span&gt; &lt;span class='o'&gt;..&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt; doesnt exist&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='k'&gt;else&lt;/span&gt;
        &lt;span class='c1'&gt;-- read it from Redis and decode&lt;/span&gt;
        &lt;span class='n'&gt;node&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;cjson&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;decode&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;node&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='k'&gt;end&lt;/span&gt;

    &lt;span class='c1'&gt;-- Nil check&lt;/span&gt;
    &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='ow'&gt;not&lt;/span&gt; &lt;span class='n'&gt;node&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;spent&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
        &lt;span class='n'&gt;node&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;spent&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='mi'&gt;0&lt;/span&gt;
    &lt;span class='k'&gt;end&lt;/span&gt;

    &lt;span class='c1'&gt;-- recurse, first spend this amount on the parent nodes&lt;/span&gt;
    &lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;parent&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;parent&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;key&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;parent&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
        &lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;spentByParent&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;spend&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;parent&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;amount&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='k'&gt;end&lt;/span&gt;

    &lt;span class='c1'&gt;-- spend this amount on the child node&lt;/span&gt;
    &lt;span class='n'&gt;node&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;spent&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;node&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;spent&lt;/span&gt; &lt;span class='o'&gt;-&lt;/span&gt; &lt;span class='n'&gt;amount&lt;/span&gt;

    &lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;nodeString&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;cjson&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;encode&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;node&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;embeddedNodeString&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;cjson&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;encode&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;nodeString&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='c1'&gt;-- escape inner quotes, adds surrounding quotes&lt;/span&gt;
    &lt;span class='c1'&gt;-- parser friendly log&lt;/span&gt;
    &lt;span class='n'&gt;redis&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;log&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;redis&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;LOG_NOTICE&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;spend.update: { &amp;quot;key&amp;quot;:&lt;/span&gt;&lt;span class='se'&gt;\&amp;quot;&lt;/span&gt;&lt;span class='s'&gt;&amp;#39;&lt;/span&gt; &lt;span class='o'&gt;..&lt;/span&gt; &lt;span class='n'&gt;key&lt;/span&gt; &lt;span class='o'&gt;..&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='se'&gt;\&amp;quot;&lt;/span&gt;&lt;span class='s'&gt;, &amp;quot;spent&amp;quot;:&amp;#39;&lt;/span&gt; &lt;span class='o'&gt;..&lt;/span&gt; &lt;span class='n'&gt;amount&lt;/span&gt; &lt;span class='o'&gt;..&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;, &amp;quot;value&amp;quot;:&amp;#39;&lt;/span&gt; &lt;span class='o'&gt;..&lt;/span&gt; &lt;span class='n'&gt;embeddedNodeString&lt;/span&gt; &lt;span class='o'&gt;..&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;}&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;

    &lt;span class='n'&gt;redis&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;call&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;SET&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;key&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;nodeString&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;

    &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;spend&lt;/span&gt;
&lt;span class='k'&gt;end&lt;/span&gt;

&lt;span class='c1'&gt;-- Since there are no arrays in Lua, only table, keep in mind that they are not 0-based, but 1&lt;/span&gt;
&lt;span class='n'&gt;spend&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;KEYS&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;],&lt;/span&gt; &lt;span class='nb'&gt;tonumber&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;ARGV&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;]))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Save this file as &lt;code&gt;spend.lua&lt;/code&gt; file and let’s run this sweetness.&lt;/p&gt;

&lt;h3 id=&quot;running_the_sweetness&quot;&gt;Running the sweetness&lt;/h3&gt;

&lt;p&gt;We need to put in some initial values. Normally you would have a separate script to initialize them. For the purpose of this article this will do:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='nv'&gt;$ &lt;/span&gt;redis-cli &lt;span class='nb'&gt;set &lt;/span&gt;a &lt;span class='s2'&gt;&amp;quot;{\&amp;quot;spent\&amp;quot;: 0}&amp;quot;&lt;/span&gt;
&lt;span class='nv'&gt;$ &lt;/span&gt;redis-cli &lt;span class='nb'&gt;set &lt;/span&gt;a.b &lt;span class='s2'&gt;&amp;quot;{\&amp;quot;spent\&amp;quot;: 0}&amp;quot;&lt;/span&gt;
&lt;span class='nv'&gt;$ &lt;/span&gt;redis-cli &lt;span class='nb'&gt;set &lt;/span&gt;a.b.c &lt;span class='s2'&gt;&amp;quot;{\&amp;quot;spent\&amp;quot;: 0}&amp;quot;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Sweet, now to run the script up-below on node &lt;code&gt;a.b.c&lt;/code&gt; with a value of &lt;code&gt;7&lt;/code&gt;:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='nv'&gt;$ &lt;/span&gt;redis-cli evalsha &lt;span class='k'&gt;$(&lt;/span&gt;redis-cli script load &lt;span class='s2'&gt;&amp;quot;$(cat ./spend.lua)&amp;quot;&lt;/span&gt;&lt;span class='k'&gt;)&lt;/span&gt; 1 &lt;span class='s2'&gt;&amp;quot;a.b.c&amp;quot;&lt;/span&gt; 7
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;a href=&quot;http://www.youtube.com/watch?v=bYPqZlhpbQo&quot;&gt;Can you feel it&lt;/a&gt;? It just ran your Lua function in Redis. Note how we pass &lt;code&gt;1&lt;/code&gt; to our script before &lt;code&gt;&amp;quot;a.b.c&amp;quot;&lt;/code&gt;, it tells Redis how many arguments should be treated as keys and how many as a script arguments, those variables &lt;code&gt;KEYS&lt;/code&gt; and &lt;code&gt;ARGV&lt;/code&gt; respectively.&lt;/p&gt;

&lt;h3 id=&quot;logs_and_the_situation&quot;&gt;Logs and the situation&lt;/h3&gt;

&lt;p&gt;All logging from your scripts goes to the Redis log, therefore to see what is happening under the covers:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='nv'&gt;$ &lt;/span&gt;tail -F /usr/local/var/log/redis.log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Check your Redis config if not found — &lt;code&gt;redis-cli CONFIG GET logfile&lt;/code&gt;.&lt;/p&gt;

&lt;h3 id=&quot;transactions_and_exception_handling&quot;&gt;Transactions and exception handling&lt;/h3&gt;

&lt;p&gt;Now, for the main part our script is good. Yet, there are some issues to it.&lt;/p&gt;

&lt;p&gt;Say, what if &lt;code&gt;a.b&lt;/code&gt; is not initialized? Then, according to our implementation we will first increase &lt;code&gt;spent&lt;/code&gt; amount on key &lt;code&gt;a&lt;/code&gt;, but then we will fail with &lt;code&gt;your script: key a.b doesn't exist&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;That will bring our system in an inconsistent state — not cool. Overall we want either all in or all out.&lt;/p&gt;

&lt;p&gt;Now there is a fairly simple thing you can do in order introduce transaction like behaviour:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Utilize &lt;code&gt;MSET&lt;/code&gt; as a single write operation. Since Redis is single threaded — you don’t have to worry about all those &lt;code&gt;GET&lt;/code&gt;s you have&lt;/li&gt;

&lt;li&gt;Wrap the whole script with Lua’s &lt;code&gt;pcall&lt;/code&gt; — basically a &lt;code&gt;try ... catch&lt;/code&gt; block&lt;/li&gt;
&lt;/ol&gt;

&lt;h4 id=&quot;_for_a_single_all_in_or_all_out&quot;&gt;&lt;code&gt;MSET&lt;/code&gt; for a single all in or all out&lt;/h4&gt;

&lt;p&gt;You’ll need an utility function at the top of your script:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='lua'&gt;&lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;_cache&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='p'&gt;{}&lt;/span&gt;
&lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;redisMSET&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='k'&gt;function&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;_&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;key&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;value&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='nb'&gt;table.insert&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;_cache&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;key&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='nb'&gt;table.insert&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;_cache&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;value&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In code you would use these statements instead of all &lt;code&gt;SET&lt;/code&gt;s:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='lua'&gt;&lt;span class='n'&gt;redisMSET&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;SET&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;a.b&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;{&amp;quot;spent&amp;quot;: 12}&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And by the end of you script you would &lt;em&gt;commit&lt;/em&gt; it all at once with &lt;code&gt;MSET&lt;/code&gt;:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='lua'&gt;&lt;span class='n'&gt;redis&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;call&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;MSET&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='nb'&gt;unpack&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;_cache&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You can also go smart about it and do a wrapper around &lt;code&gt;GET&lt;/code&gt; that will first check your &lt;code&gt;_cache&lt;/code&gt; if it holds the desired key and if not — perform a call with &lt;code&gt;redis.call('GET'...&lt;/code&gt;.&lt;/p&gt;

&lt;h4 id=&quot;wrapping_into____block&quot;&gt;Wrapping into &lt;code&gt;try&lt;/code&gt; … &lt;code&gt;catch&lt;/code&gt; block&lt;/h4&gt;

&lt;p&gt;There is no magic with this one — you wrap the whole thing in &lt;code&gt;pcall&lt;/code&gt; and you are done — it gives you &lt;code&gt;status&lt;/code&gt; variable, that tells you if it went fine or not and the result of executing that block of code.&lt;/p&gt;

&lt;p&gt;The code will go like this —&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='lua'&gt;&lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;main&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='k'&gt;function&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
    
    &lt;span class='c1'&gt;-- Your code goes here and constructs some `result` object&lt;/span&gt;

    &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;result&lt;/span&gt;
&lt;span class='k'&gt;end&lt;/span&gt;

&lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;status&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;res&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='nb'&gt;pcall&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;main&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;

&lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;status&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
    &lt;span class='c1'&gt;-- `main&amp;#39; went fine: return `result`&lt;/span&gt;
    &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;res&lt;/span&gt;
&lt;span class='k'&gt;else&lt;/span&gt;
    &lt;span class='c1'&gt;-- `main&amp;#39; raised an error: take appropriate actions&lt;/span&gt;
    &lt;span class='c1'&gt;-- there is no redis.LOG_ERROR level&lt;/span&gt;
    &lt;span class='n'&gt;redis&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;log&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;redis&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;LOG_WARNING&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;error: &amp;#39;&lt;/span&gt; &lt;span class='o'&gt;..&lt;/span&gt; &lt;span class='n'&gt;res&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;redis&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;error_reply&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;error: &amp;#39;&lt;/span&gt; &lt;span class='o'&gt;..&lt;/span&gt; &lt;span class='n'&gt;res&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Combining it together with transactions:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='lua'&gt;&lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;main&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='k'&gt;function&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
    &lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;_cache&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='p'&gt;{}&lt;/span&gt;
    &lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;redisMSET&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='k'&gt;function&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;_&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;key&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;value&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
        &lt;span class='nb'&gt;table.insert&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;_cache&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;key&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
        &lt;span class='nb'&gt;table.insert&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;_cache&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;value&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='k'&gt;end&lt;/span&gt;

    &lt;span class='c1'&gt;-- your code goes here and constructs some `result` object&lt;/span&gt;

    &lt;span class='n'&gt;redis&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;call&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;MSET&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='nb'&gt;unpack&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;_cache&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;

    &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;result&lt;/span&gt;
&lt;span class='k'&gt;end&lt;/span&gt;

&lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;status&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;res&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='nb'&gt;pcall&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;main&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;

&lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;status&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
    &lt;span class='c1'&gt;-- `main&amp;#39; went fine: return `result`&lt;/span&gt;
    &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;res&lt;/span&gt;
&lt;span class='k'&gt;else&lt;/span&gt;
    &lt;span class='c1'&gt;-- `main&amp;#39; raised an error: take appropriate actions&lt;/span&gt;
    &lt;span class='c1'&gt;-- there is no redis.LOG_ERROR level&lt;/span&gt;
    &lt;span class='n'&gt;redis&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;log&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;redis&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;LOG_WARNING&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;error: &amp;#39;&lt;/span&gt; &lt;span class='o'&gt;..&lt;/span&gt; &lt;span class='n'&gt;res&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;redis&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;error_reply&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;error: &amp;#39;&lt;/span&gt; &lt;span class='o'&gt;..&lt;/span&gt; &lt;span class='n'&gt;res&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='k'&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Voilà!&lt;/p&gt;

&lt;h3 id=&quot;unittesting_our_sweet_lua_awesomeness&quot;&gt;Unit-Testing our sweet Lua awesomeness&lt;/h3&gt;

&lt;p&gt;Now all this is good, but here at Screen6 we do unit-testing, and just to be sure and because it is a good way to go about things.&lt;/p&gt;

&lt;p&gt;There are two ways you can go about tests:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Test your Lua code with Lua unit tests&lt;/li&gt;

&lt;li&gt;Test your Lua code on the application level. In our case — calling Lua script within Redis from CoffeeScript&lt;/li&gt;
&lt;/ol&gt;

&lt;h3 id=&quot;unit_testing_with_busted&quot;&gt;Unit Testing with Busted&lt;/h3&gt;

&lt;p&gt;We use &lt;a href=&quot;http://olivinelabs.com/busted/&quot;&gt;Busted&lt;/a&gt; framework to run unit tests on our Lua scripts. If you are familiar with &lt;a href=&quot;http://visionmedia.github.io/mocha/&quot;&gt;Mocha&lt;/a&gt;, you will feel at home right away.&lt;/p&gt;

&lt;p&gt;Testing is rather straightforward, there is only one thing to note, that you would prefer to run tests “as if you are in Redis”, and therefore you would require some wrapper code to mock the API Redis provides you within Lua.&lt;/p&gt;

&lt;p&gt;A very basic implementation that will enable you to use these operations:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;redis.call( ‘SET’, … )&lt;/li&gt;

&lt;li&gt;redis.call( ‘MSET’, … )&lt;/li&gt;

&lt;li&gt;redis.call( ‘GET’, … )&lt;/li&gt;

&lt;li&gt;redis.log( … )&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Will look like this:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='lua'&gt;&lt;span class='n'&gt;cjson&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='nb'&gt;require&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='s'&gt;cjson&amp;quot;&lt;/span&gt;

&lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;DATABASE&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='p'&gt;{}&lt;/span&gt;

&lt;span class='k'&gt;function&lt;/span&gt; &lt;span class='nf'&gt;switch&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;t&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='n'&gt;t&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;case&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='k'&gt;function&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;self&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
        &lt;span class='kd'&gt;local&lt;/span&gt; &lt;span class='n'&gt;f&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;self&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='ow'&gt;or&lt;/span&gt; &lt;span class='n'&gt;self&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;default&lt;/span&gt;
        &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;f&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
            &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='nb'&gt;type&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='o'&gt;==&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='s'&gt;function&amp;quot;&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
                &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;f&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;self&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
            &lt;span class='k'&gt;else&lt;/span&gt;
                &lt;span class='nb'&gt;error&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='s'&gt;case &amp;quot;&lt;/span&gt;&lt;span class='o'&gt;..&lt;/span&gt;&lt;span class='nb'&gt;tostring&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;&lt;span class='o'&gt;..&lt;/span&gt;&lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='s'&gt; not a function&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
            &lt;span class='k'&gt;end&lt;/span&gt;
        &lt;span class='k'&gt;end&lt;/span&gt;
    &lt;span class='k'&gt;end&lt;/span&gt;
      &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;t&lt;/span&gt;
&lt;span class='k'&gt;end&lt;/span&gt;

&lt;span class='n'&gt;redis&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='n'&gt;call&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='k'&gt;function&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;operation&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='o'&gt;...&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
        &lt;span class='n'&gt;mockRedis&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;switch&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt;
            &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;SET&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='k'&gt;function&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
                    &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='o'&gt;#&lt;/span&gt;&lt;span class='n'&gt;arg&lt;/span&gt; &lt;span class='o'&gt;~=&lt;/span&gt; &lt;span class='mi'&gt;2&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
                        &lt;span class='nb'&gt;error&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;invalid amount of argumetns passed on to mockRedis.set&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
                    &lt;span class='k'&gt;else&lt;/span&gt;
                        &lt;span class='n'&gt;DATABASE&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;arg&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;]]&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;cjson&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;decode&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;arg&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='mi'&gt;2&lt;/span&gt;&lt;span class='p'&gt;])&lt;/span&gt;
                    &lt;span class='k'&gt;end&lt;/span&gt;
                &lt;span class='k'&gt;end&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
            &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;MSET&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='k'&gt;function&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
                    &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='o'&gt;#&lt;/span&gt;&lt;span class='n'&gt;arg&lt;/span&gt; &lt;span class='o'&gt;%&lt;/span&gt; &lt;span class='mi'&gt;2&lt;/span&gt; &lt;span class='o'&gt;~=&lt;/span&gt; &lt;span class='mi'&gt;0&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
                        &lt;span class='nb'&gt;error&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;invalid amount or arguments (not even) passed on to the mockRedis.mset&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
                    &lt;span class='k'&gt;else&lt;/span&gt;
                        &lt;span class='k'&gt;for&lt;/span&gt; &lt;span class='n'&gt;i&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='o'&gt;#&lt;/span&gt;&lt;span class='n'&gt;arg&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='mi'&gt;2&lt;/span&gt; &lt;span class='k'&gt;do&lt;/span&gt;
                            &lt;span class='n'&gt;DATABASE&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;arg&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;i&lt;/span&gt;&lt;span class='p'&gt;]]&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='n'&gt;cjson&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;decode&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;arg&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;i&lt;/span&gt; &lt;span class='o'&gt;+&lt;/span&gt; &lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;])&lt;/span&gt;
                        &lt;span class='k'&gt;end&lt;/span&gt;
                    &lt;span class='k'&gt;end&lt;/span&gt;
                &lt;span class='k'&gt;end&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
            &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;GET&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='k'&gt;function&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
                    &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='o'&gt;#&lt;/span&gt;&lt;span class='n'&gt;arg&lt;/span&gt; &lt;span class='o'&gt;~=&lt;/span&gt; &lt;span class='mi'&gt;1&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
                        &lt;span class='nb'&gt;error&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;invalid amount of arguments passed on to mockRedis.get&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
                    &lt;span class='k'&gt;else&lt;/span&gt;
                        &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='n'&gt;DATABASE&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;arg&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;]]&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt;
                            &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;cjson&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='n'&gt;encode&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;DATABASE&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='n'&gt;arg&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;]])&lt;/span&gt;
                        &lt;span class='k'&gt;else&lt;/span&gt;
                            &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='kc'&gt;nil&lt;/span&gt;
                        &lt;span class='k'&gt;end&lt;/span&gt;
                    &lt;span class='k'&gt;end&lt;/span&gt;
                &lt;span class='k'&gt;end&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
            &lt;span class='n'&gt;default&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='k'&gt;function&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;x&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
                    &lt;span class='nb'&gt;error&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt;unsupported method &amp;#39;&lt;/span&gt; &lt;span class='o'&gt;..&lt;/span&gt; &lt;span class='n'&gt;operation&lt;/span&gt; &lt;span class='o'&gt;..&lt;/span&gt; &lt;span class='s1'&gt;&amp;#39;&lt;/span&gt;&lt;span class='s'&gt; called on mockRedis&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
                &lt;span class='k'&gt;end&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
        &lt;span class='p'&gt;}&lt;/span&gt;
        &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='n'&gt;mockRedis&lt;/span&gt;&lt;span class='p'&gt;:&lt;/span&gt;&lt;span class='n'&gt;case&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;operation&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
    &lt;span class='k'&gt;end&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;

    &lt;span class='n'&gt;LOG_DEBUG&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='s'&gt;DEBUG&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='n'&gt;LOG_VERBOSE&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='s'&gt;VERBOSE&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='n'&gt;LOG_NOTICE&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='s'&gt;NOTICE&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='n'&gt;LOG_WARNING&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;&lt;/span&gt;&lt;span class='s'&gt;LOG_WARNING&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;

    &lt;span class='n'&gt;log&lt;/span&gt; &lt;span class='o'&gt;=&lt;/span&gt; &lt;span class='k'&gt;function&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='n'&gt;level&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='n'&gt;message&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
        &lt;span class='c1'&gt;--print(level .. &amp;quot;# &amp;quot; .. message)&lt;/span&gt;
    &lt;span class='k'&gt;end&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It might be just slightly overwhelming if you are not that much into Lua, although — it’s pretty basic, once you get your head around it, it won’t be a biggy to extend it further, to suit your needs.&lt;/p&gt;

&lt;h3 id=&quot;integration_test_spawning_redis_process_from_nodejs_to_execute_lua_in_it&quot;&gt;Integration test: Spawning Redis process from Node.JS to execute Lua in it&lt;/h3&gt;

&lt;p&gt;Now, for the simplicity sake of this article I will drop the part about doing integration test through a real instance of Redis.&lt;/p&gt;

&lt;p&gt;In short we wrote a wrapper that launches Redis from Node.JS while you are running your Mocha tests in &lt;code&gt;before&lt;/code&gt; and &lt;code&gt;after&lt;/code&gt; blocks, something like this —&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='coffeescript'&gt;&lt;span class='nv'&gt;RedisServer = &lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nx'&gt;require&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;./redis_spawn&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;).&lt;/span&gt;&lt;span class='nx'&gt;RedisServer&lt;/span&gt;
&lt;span class='nv'&gt;redisServerOpts =&lt;/span&gt;
    &lt;span class='nv'&gt;workingDirectory: &lt;/span&gt;&lt;span class='nx'&gt;RedisServer&lt;/span&gt;&lt;span class='o'&gt;::&lt;/span&gt;&lt;span class='nx'&gt;optionsDefault&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;workingDirectory&lt;/span&gt;
    &lt;span class='nv'&gt;save: &lt;/span&gt;&lt;span class='kc'&gt;true&lt;/span&gt;
    &lt;span class='nv'&gt;timeout: &lt;/span&gt;&lt;span class='mi'&gt;2000&lt;/span&gt;
&lt;span class='nv'&gt;redisServer = &lt;/span&gt;&lt;span class='k'&gt;new&lt;/span&gt; &lt;span class='nx'&gt;redisSpawn&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;RedisServer&lt;/span&gt; &lt;span class='nx'&gt;redisServerOpts&lt;/span&gt;

&lt;span class='p'&gt;...&lt;/span&gt;

    &lt;span class='nx'&gt;before&lt;/span&gt; &lt;span class='nf'&gt;(done) -&amp;gt;&lt;/span&gt;
        &lt;span class='nx'&gt;redisServer&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;start&lt;/span&gt; &lt;span class='p'&gt;()&lt;/span&gt; &lt;span class='nf'&gt;-&amp;gt;&lt;/span&gt;
            &lt;span class='nv'&gt;redisClient = &lt;/span&gt;&lt;span class='nx'&gt;redis&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;createClient&lt;/span&gt; &lt;span class='nx'&gt;redisServerOpts&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;config&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;port&lt;/span&gt;
            &lt;span class='nx'&gt;redisClient&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;once&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;connect&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='p'&gt;()&lt;/span&gt; &lt;span class='nf'&gt;-&amp;gt;&lt;/span&gt;
                &lt;span class='nx'&gt;redisClient&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;flushall&lt;/span&gt; &lt;span class='nx'&gt;done&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And then interacts with the Lua script that is running on the recently spawned Redis instance. Might there be any interest in it — we’ll put up a separate article on the topic. Don’t hesitate to reach out to us!&lt;/p&gt;

&lt;h2 id=&quot;in_production&quot;&gt;In Production&lt;/h2&gt;

&lt;h3 id=&quot;installing_lua_script_upon_application_start&quot;&gt;Installing Lua script upon application start&lt;/h3&gt;

&lt;p&gt;Now that you have your Lua scripts thoroughly tested it is time to run them in production. The basic idea is to load them once on application startup and keep the resulting &lt;code&gt;SHA&lt;/code&gt;, so that you won’t have to send the script there and back each and every time upon request.&lt;/p&gt;

&lt;p&gt;Instead of thousand of words, the CoffeeScript snippet that will do just that —&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='coffeescript'&gt;&lt;span class='nv'&gt;redis = &lt;/span&gt;&lt;span class='nx'&gt;require&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;redis&amp;#39;&lt;/span&gt;

&lt;span class='nv'&gt;module.exports.YourDbClient =&lt;/span&gt;
&lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='nx'&gt;RdbClient&lt;/span&gt; &lt;span class='k'&gt;extends&lt;/span&gt; &lt;span class='nx'&gt;EventEmitter&lt;/span&gt;
    &lt;span class='nv'&gt;constructor: &lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt; &lt;span class='nf'&gt;-&amp;gt;&lt;/span&gt;
        &lt;span class='vi'&gt;@scripts = &lt;/span&gt;&lt;span class='p'&gt;{&lt;/span&gt;
            &lt;span class='nv'&gt;someScript1:&lt;/span&gt;
                &lt;span class='nv'&gt;text: &lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nx'&gt;fs&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;readFileSync&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nx'&gt;path&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;join&lt;/span&gt; &lt;span class='nx'&gt;__dirname&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;someScript1.lua&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)).&lt;/span&gt;&lt;span class='nx'&gt;toString&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
            &lt;span class='nv'&gt;someScript2:&lt;/span&gt;
                &lt;span class='nv'&gt;text: &lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nx'&gt;fs&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;readFileSync&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nx'&gt;path&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;join&lt;/span&gt; &lt;span class='nx'&gt;__dirname&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;someScript2.lua&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;)).&lt;/span&gt;&lt;span class='nx'&gt;toString&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
                &lt;span class='nv'&gt;sha1: &lt;/span&gt;&lt;span class='kc'&gt;null&lt;/span&gt;
        &lt;span class='p'&gt;}&lt;/span&gt;
        &lt;span class='nv'&gt;script.name = &lt;/span&gt;&lt;span class='nx'&gt;name&lt;/span&gt; &lt;span class='k'&gt;for&lt;/span&gt; &lt;span class='nx'&gt;name&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='nx'&gt;script&lt;/span&gt; &lt;span class='k'&gt;of&lt;/span&gt; &lt;span class='nx'&gt;@scripts&lt;/span&gt;      &lt;span class='c1'&gt;# copy name -&amp;gt; .name&lt;/span&gt;
        &lt;span class='nx'&gt;@connect&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;

    &lt;span class='nv'&gt;connect: &lt;/span&gt;&lt;span class='nf'&gt;(cb) -&amp;gt;&lt;/span&gt;
        &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='nx'&gt;@rdb&lt;/span&gt; &lt;span class='k'&gt;then&lt;/span&gt; &lt;span class='k'&gt;return&lt;/span&gt; &lt;span class='nx'&gt;cb&lt;/span&gt;&lt;span class='o'&gt;?&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;

        &lt;span class='vi'&gt;@rdb = &lt;/span&gt;&lt;span class='nx'&gt;redis&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;createClient&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&lt;/span&gt;&lt;span class='nx'&gt;redisPort&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&lt;/span&gt;&lt;span class='nx'&gt;redisHost&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='o'&gt;&amp;lt;&lt;/span&gt;&lt;span class='nx'&gt;redisOpts&lt;/span&gt;&lt;span class='o'&gt;&amp;gt;&lt;/span&gt;

        &lt;span class='nv'&gt;loadScripts = &lt;/span&gt;&lt;span class='nf'&gt;(cb) =&amp;gt;&lt;/span&gt;
            &lt;span class='nv'&gt;loader = &lt;/span&gt;&lt;span class='nx'&gt;@rdb&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;multi&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
            &lt;span class='nx'&gt;loader&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;script&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;load&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='nx'&gt;@scripts&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;someScript1&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;text&lt;/span&gt;
            &lt;span class='nx'&gt;loader&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;script&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;load&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='nx'&gt;@scripts&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;someScript2&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;text&lt;/span&gt;
            &lt;span class='nx'&gt;loader&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nb'&gt;eval&lt;/span&gt; &lt;span class='nx'&gt;@scripts&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;configure&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;text&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='mi'&gt;0&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nx'&gt;JSON&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;stringify&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='nv'&gt;clients: &lt;/span&gt;&lt;span class='nx'&gt;@config&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;bidder&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;clients&lt;/span&gt; &lt;span class='p'&gt;}),&lt;/span&gt; &lt;span class='nb'&gt;Date&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;now&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
            &lt;span class='nx'&gt;loader&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;script&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;load&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='nx'&gt;@scripts&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;spend&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;text&lt;/span&gt;
            &lt;span class='nx'&gt;loader&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;exec&lt;/span&gt; &lt;span class='nf'&gt;(err, results) =&amp;gt;&lt;/span&gt;
                &lt;span class='k'&gt;if&lt;/span&gt; &lt;span class='nx'&gt;err&lt;/span&gt;
                    &lt;span class='nx'&gt;cb&lt;/span&gt;&lt;span class='o'&gt;?&lt;/span&gt; &lt;span class='nx'&gt;err&lt;/span&gt;
                    &lt;span class='k'&gt;throw&lt;/span&gt; &lt;span class='nx'&gt;err&lt;/span&gt;
                &lt;span class='vi'&gt;@scripts.someScript1.sha1 = &lt;/span&gt;&lt;span class='nx'&gt;results&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='mi'&gt;0&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
                &lt;span class='vi'&gt;@scripts.someScript2.sha1 = &lt;/span&gt;&lt;span class='nx'&gt;results&lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='mi'&gt;1&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
                &lt;span class='nx'&gt;cb&lt;/span&gt;&lt;span class='o'&gt;?&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;

        &lt;span class='nx'&gt;@rdb&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;on&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;connect&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='p'&gt;()&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt;
            &lt;span class='nx'&gt;loadScripts&lt;/span&gt; &lt;span class='p'&gt;()&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='nx'&gt;@emit&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;connected&amp;#39;&lt;/span&gt;
        &lt;span class='nx'&gt;@rdb&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;on&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;reconnect&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='p'&gt;()&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt;
            &lt;span class='nx'&gt;loadScripts&lt;/span&gt; &lt;span class='p'&gt;()&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='nx'&gt;@emit&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;reconnected&amp;#39;&lt;/span&gt;
        &lt;span class='nx'&gt;@rdb&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;once&lt;/span&gt; &lt;span class='s'&gt;&amp;#39;end&amp;#39;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='p'&gt;()&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt;
            &lt;span class='vi'&gt;@rdb = &lt;/span&gt;&lt;span class='kc'&gt;null&lt;/span&gt;

    &lt;span class='nv'&gt;actionWithRedis: &lt;/span&gt;&lt;span class='nf'&gt;(args...) -&amp;gt;&lt;/span&gt;
        &lt;span class='nx'&gt;@txn&lt;/span&gt; &lt;span class='o'&gt;?=&lt;/span&gt; &lt;span class='nx'&gt;@rdb&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;multi&lt;/span&gt;&lt;span class='p'&gt;()&lt;/span&gt;
        &lt;span class='vi'&gt;@operation = &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nx'&gt;@client&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;scripts&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;spend&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;sha1&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
        &lt;span class='nx'&gt;@txn&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;evalsha&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;apply&lt;/span&gt; &lt;span class='nx'&gt;@txn&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nx'&gt;@operation&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;concat&lt;/span&gt; &lt;span class='nx'&gt;args&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
        &lt;span class='nx'&gt;@txn&lt;/span&gt;&lt;span class='p'&gt;.&lt;/span&gt;&lt;span class='nx'&gt;exec&lt;/span&gt; &lt;span class='nf'&gt;(err, results) =&amp;gt;&lt;/span&gt;
            &lt;span class='c1'&gt;# further sweetness&lt;/span&gt;
            &lt;span class='p'&gt;...&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;puppet_configuration_for_jenkins&quot;&gt;Puppet configuration for Jenkins&lt;/h3&gt;

&lt;p&gt;We utilize Jenkins with JUnit test result reports, Busted works with it just fine with XUnit reporting engine —&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;&lt;span class='nv'&gt;$ &lt;/span&gt;busted -o junit ./test
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And here are the small bits of puppet configuration to enable your Jenkins with Lua, Busted and the necessary libs:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='ruby'&gt;&lt;span class='k'&gt;class&lt;/span&gt; &lt;span class='ss'&gt;genericpackages&lt;/span&gt;&lt;span class='p'&gt;:&lt;/span&gt;&lt;span class='ss'&gt;:lua&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt;
    &lt;span class='n'&gt;package&lt;/span&gt; &lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;luarocks&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;:&lt;/span&gt;
        &lt;span class='k'&gt;ensure&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='n'&gt;installed&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='nb'&gt;exec&lt;/span&gt;&lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;install busted&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;:&lt;/span&gt;
        &lt;span class='n'&gt;command&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;luarocks install busted&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
        &lt;span class='nb'&gt;require&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='no'&gt;Package&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;luarocks&amp;#39;&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;}&lt;/span&gt;
    &lt;span class='nb'&gt;exec&lt;/span&gt;&lt;span class='p'&gt;{&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;install cjson redis library&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;:&lt;/span&gt;
        &lt;span class='n'&gt;command&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='s2'&gt;&amp;quot;luarocks install lua-cjson&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
        &lt;span class='nb'&gt;require&lt;/span&gt; &lt;span class='o'&gt;=&amp;gt;&lt;/span&gt; &lt;span class='no'&gt;Package&lt;/span&gt;&lt;span class='o'&gt;[&lt;/span&gt;&lt;span class='s1'&gt;&amp;#39;luarocks&amp;#39;&lt;/span&gt;&lt;span class='o'&gt;]&lt;/span&gt;&lt;span class='p'&gt;,&lt;/span&gt;
    &lt;span class='p'&gt;}&lt;/span&gt;
&lt;span class='p'&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;summary&quot;&gt;Summary&lt;/h2&gt;

&lt;p&gt;Four months into the game — works as a charm, easy to monitor. We are very happy with transition of our accounting logic into Lua scripts executed directly in the Redis.&lt;/p&gt;

&lt;h2 id=&quot;links&quot;&gt;Links&lt;/h2&gt;

&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;http://www.lua.org/&quot;&gt;Lua Main Page&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href=&quot;http://github.com/keplerproject/luarocks&quot;&gt;LuaRocks&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href=&quot;http://luarocks.org/en/Installation_instructions_for_Mac_OS_X&quot;&gt;Installing Lua Rocks on Mac&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href=&quot;http://www.redisgreen.net/blog/intro-to-lua-for-redis-programmers/&quot;&gt;Intro to Lua for Redis programmers&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;[Originally published in &lt;a href=&quot;http://screen6.github.io/blog/2014/09/18/lua-scripts-in-redis-within-nodejs.html&quot;&gt;Screen6 Technical Blog&lt;/a&gt; on 09/18/2014]&lt;/em&gt;&lt;/p&gt;
</content>
 </entry>
 
 <entry>
   <title>HyperLogLog with Cascalog</title>
   <link href="http://ilyapimenov.com/blog/2013/11/14/hyperloglog-with-cascalog.html"/>
   <updated>2013-11-14T00:00:00+01:00</updated>
   <id>http://ilyapimenov.com/blog/2013/11/14/hyperloglog-with-cascalog</id>
   <content type="html">
&lt;p&gt;&lt;em&gt;Updated: 22 nov 2013&lt;/em&gt;&lt;/p&gt;

&lt;p&gt;We’ll look briefly in how you would utilize awesomeness of both Cascalog and HyperLogLog in order to execute Hadoop M/R tasks with amounts of data too big to have them in their original form.&lt;/p&gt;
&lt;hr /&gt;
&lt;h1 id=&quot;intro&quot;&gt;Intro&lt;/h1&gt;
&lt;dl&gt;
  &lt;dt&gt;&lt;strong&gt;HyperLogLog&lt;/strong&gt;&lt;/dt&gt;
  &lt;dd&gt;Cardinality estimator allowing you to count amount of distinct values.&lt;/dd&gt;
  &lt;dt&gt;&lt;strong&gt;Cascalog&lt;/strong&gt;&lt;/dt&gt;
  &lt;dd&gt;The main use cases for Cascalog are processing &quot;Big Data&quot; on top of Hadoop or doing analysis on your local computer. Cascalog is a replacement for tool like Pig, Hive, and Cascading which operates at a significantly higher level of abstraction than those tools.&lt;/dd&gt;
&lt;/dl&gt;
&lt;h1 id=&quot;prerequisites&quot;&gt;Prerequisites&lt;/h1&gt;

&lt;p&gt;We’ll assume you are already familiar with the &lt;a href=&quot;http://clojure.org/&quot;&gt;Clojure&lt;/a&gt;, &lt;a href=&quot;https://github.com/nathanmarz/cascalog&quot;&gt;Cascalog&lt;/a&gt; framework and &lt;a href=&quot;http://blog.aggregateknowledge.com/2012/10/25/sketch-of-the-day-hyperloglog-cornerstone-of-a-big-data-infrastructure/&quot;&gt;HyperLogLog&lt;/a&gt; algorithm. Otherwise — jump straight to the bottom for some links, there are some nice reads there.&lt;/p&gt;

&lt;h1 id=&quot;counting_passengers&quot;&gt;Counting Passengers&lt;/h1&gt;

&lt;h2 id=&quot;task_as_stated&quot;&gt;Task as stated&lt;/h2&gt;

&lt;p&gt;We’ll deal with an example that is similar in its mechanics with a task we face ourselves at &lt;a href=&quot;http://screen6.io/&quot;&gt;Screen6&lt;/a&gt;, yet being from another market — passenger transportation.&lt;/p&gt;

&lt;p&gt;We are located in Amsterdam, and here, in Netherlands, you have this simple and easy system of public transport accessed by NFC card and which works as follows: prior to accessing the public transport (whether that be a tram, a bus or a train for that matter), you check-in by scanning your card, and once you get to your destination — you check-out with that same NFC card (which is called “OV-Chipkaart”).&lt;/p&gt;

&lt;p&gt;It’s convenient, I use all the time, whenever I’m neither biking or walking.&lt;/p&gt;

&lt;p&gt;Now imagine you have all these populous cities and people commuting between them on a daily/weekly/monthly/yearly basis, how would you monitor that traffic?&lt;/p&gt;

&lt;p&gt;Say, you want to see distribution of passengers in a certain city district (identified by zipcode) over time, and on top of that you’d love to see that same distribution over a month for two districts? Or three districts? Or two cities altogether?&lt;/p&gt;

&lt;p&gt;You can just store all events without any aggregations and directly do queries on that dataset, but it possesses two issues within itself: perfomance concern, as we are dealing with what supposed to be a very big amount of data, and hence — persistence issues.&lt;/p&gt;

&lt;p&gt;You cannot just store the list of unique passengers in all the districts per each smallest time-unit — it will be simply way too big to process and access for further analytics; and you cannot just store count of unique passengers, as that information is useless once you come to merging traffic in the different districts and cities (certainly those sets intersect heavily — it is very common to live in The Hague and work either in Amsterdam, Amsterdam Sloterdijk or Schiphol).&lt;/p&gt;

&lt;p&gt;That is where a &lt;em&gt;caridnality estimator&lt;/em&gt; comes in handy. It doesn’t provide you with an exact number, but rather tells you what the cardinality of a certain set is with a desired error margin, yet being comparatively dense to the initial set of original items and allowing you to merge different sets.&lt;/p&gt;

&lt;p&gt;A certain number of algorithms has popped out lately one of them being &lt;strong&gt;HyperLogLog&lt;/strong&gt;, and that is the one we are taking with us on our Cascalog-ride.&lt;/p&gt;

&lt;h2 id=&quot;formatting_and_sample_dataset&quot;&gt;Formatting and sample dataset&lt;/h2&gt;

&lt;p&gt;We are assuming that we have OV-Chipkaart access-logs: each and every swipe (Log file line) gives you a record of &lt;code&gt;city&lt;/code&gt;, &lt;code&gt;district&lt;/code&gt;, &lt;code&gt;tag&lt;/code&gt; and &lt;code&gt;timestamp&lt;/code&gt;:&lt;/p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;field&lt;/th&gt;&lt;th&gt;type&lt;/th&gt;&lt;th&gt;example&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;&lt;code&gt;city&lt;/code&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Varchar&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Amsterdam&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;&lt;code&gt;district&lt;/code&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Zipcode&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;1015&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;&lt;code&gt;tag&lt;/code&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;UUID&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;96e4bfec-8cf5-4af1-9469-b7f0dc36dc29&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;&lt;code&gt;timestamp&lt;/code&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Ms. from Epoch&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;1363026503&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;&lt;p style='text-align: center;'&gt;Table 1. OV-Chipkaart access log record format&lt;/p&gt;
&lt;p&gt;Now, we didn’t get any logs from OV-Chipkaarts proprietor (though, I would’ve been delighted to get my hands on them), so we will have to generate some randomized data them ourselves. Here is the clojure code snippet code that will do just that:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='clojure'&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='k'&gt;def &lt;/span&gt;&lt;span class='nv'&gt;cities&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;Amsterdam&amp;quot;&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;Groningen&amp;quot;&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;Haarlem&amp;quot;&lt;/span&gt;
  &lt;span class='s'&gt;&amp;quot;Den-Haag&amp;quot;&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;Utrecht&amp;quot;&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;Delft&amp;quot;&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;Edam&amp;quot;&lt;/span&gt; &lt;span class='p'&gt;])&lt;/span&gt;

&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='k'&gt;def &lt;/span&gt;&lt;span class='nv'&gt;tags&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;repeatedly&lt;/span&gt; &lt;span class='mi'&gt;10000&lt;/span&gt; &lt;span class='o'&gt;#&lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;str &lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;java.util.UUID/randomUUID&lt;/span&gt;&lt;span class='p'&gt;))))&lt;/span&gt;

&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kd'&gt;defn &lt;/span&gt;&lt;span class='nv'&gt;line&lt;/span&gt; &lt;span class='p'&gt;[]&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='k'&gt;let &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;city&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;rand-nth&lt;/span&gt; &lt;span class='nv'&gt;cities&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
        &lt;span class='nv'&gt;district&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;+ &lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;+ &lt;/span&gt;&lt;span class='mi'&gt;10&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;rand-int &lt;/span&gt;&lt;span class='mi'&gt;89&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;* &lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;+ &lt;/span&gt;&lt;span class='mi'&gt;10&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;rand-int &lt;/span&gt;&lt;span class='mi'&gt;89&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt; &lt;span class='mi'&gt;100&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
        &lt;span class='nv'&gt;tag&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;rand-nth&lt;/span&gt; &lt;span class='nv'&gt;tags&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
        &lt;span class='nv'&gt;timestamp&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;+ &lt;/span&gt;&lt;span class='mi'&gt;1351680873&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;rand-int &lt;/span&gt;&lt;span class='mi'&gt;31536001&lt;/span&gt;&lt;span class='p'&gt;))]&lt;/span&gt;
        &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;str &lt;/span&gt;&lt;span class='nv'&gt;city&lt;/span&gt; &lt;span class='s'&gt;&amp;quot; &amp;quot;&lt;/span&gt; &lt;span class='nv'&gt;district&lt;/span&gt; &lt;span class='s'&gt;&amp;quot; &amp;quot;&lt;/span&gt; &lt;span class='nv'&gt;tag&lt;/span&gt; &lt;span class='s'&gt;&amp;quot; &amp;quot;&lt;/span&gt; &lt;span class='nv'&gt;timestamp&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;\n&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)))&lt;/span&gt;

&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;use&lt;/span&gt; &lt;span class='ss'&gt;&amp;#39;clojure.java.io&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;with-open &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;wrtr&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;writer&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;./ov-chipkaart-accesslogs.txt&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;)]&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;dotimes &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;_&lt;/span&gt; &lt;span class='mi'&gt;5000000&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;.write&lt;/span&gt; &lt;span class='nv'&gt;wrtr&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;line&lt;/span&gt;&lt;span class='p'&gt;))))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This would provide us with a file of approximate 157Mb size holding 5.000.000 OV-chipkaart accesslog records; gziped — 78Mb.&lt;/p&gt;

&lt;h2 id=&quot;defining_incoming_datasets&quot;&gt;Defining incoming datasets&lt;/h2&gt;

&lt;p&gt;Normally you would define one &lt;code&gt;source&lt;/code&gt; function per dataset type as a simple cascalog query, that does reading, mapping, type checks and conversions. Our example won’t be any different — we’ll read the file line-by-line from Hadoop File System (which will nicely pickup both gzippped and not gzipped files for us):&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='clojure'&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kd'&gt;ns &lt;/span&gt;&lt;span class='nv'&gt;...&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:require&lt;/span&gt; &lt;span class='nv'&gt;...&lt;/span&gt;
            &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;cascalog.api&lt;/span&gt; &lt;span class='ss'&gt;:as&lt;/span&gt; &lt;span class='nv'&gt;c&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
            &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;cascalog.ops&lt;/span&gt; &lt;span class='ss'&gt;:as&lt;/span&gt; &lt;span class='nv'&gt;ops&lt;/span&gt;&lt;span class='p'&gt;]))&lt;/span&gt;

&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='k'&gt;def &lt;/span&gt;&lt;span class='nv'&gt;ov-fields&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='s'&gt;&amp;quot;?city&amp;quot;&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;?district&amp;quot;&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;?uuid&amp;quot;&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;?timestamp&amp;quot;&lt;/span&gt;&lt;span class='p'&gt;])&lt;/span&gt;

&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kd'&gt;defn &lt;/span&gt;&lt;span class='nv'&gt;ov-source&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;&amp;quot;&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;directory&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='k'&gt;let &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;source&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;get-tap&lt;/span&gt; &lt;span class='nv'&gt;directory&lt;/span&gt;&lt;span class='p'&gt;)]&lt;/span&gt;
    &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;c/&amp;lt;-&lt;/span&gt; &lt;span class='nv'&gt;ov-fields&lt;/span&gt;
          &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;source&lt;/span&gt; &lt;span class='ss'&gt;:&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class='nv'&gt;ov-fields&lt;/span&gt;&lt;span class='p'&gt;))))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we have an &lt;code&gt;ov-source&lt;/code&gt; cascalog query, which can be utilized as an incoming data stream; without caring too much if the data is correct or not.&lt;/p&gt;
&lt;div class='note'&gt;Add filters to the ov-source query, in order to drop undesired corrupted data.&lt;/div&gt;
&lt;h2 id=&quot;which_one&quot;&gt;Which one?&lt;/h2&gt;

&lt;p&gt;Now, you can either go and implement your own implementation of HyperLogLog that will suit your needs, or you can pick one of the following already existing opensourced implementatoins:&lt;/p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;Company&lt;/th&gt;&lt;th&gt;Library&lt;/th&gt;&lt;th&gt;Link&lt;/th&gt;&lt;th&gt;Language&lt;/th&gt;&lt;th&gt;License&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Facebook&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;&lt;a href=&quot;https://github.com/facebook/jcommon/&quot;&gt;JCommon&lt;/a&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;&lt;a href=&quot;https://github.com/facebook/jcommon/blob/master/stats/src/main/java/com/facebook/stats/cardinality/HyperLogLog.java&quot;&gt;HyperLogLog.java&lt;/a&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Java&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Apache License 2.0&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Twitter&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;&lt;a href=&quot;https://github.com/twitter/algebird/&quot;&gt;Algebird&lt;/a&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;&lt;a href=&quot;https://github.com/twitter/algebird/blob/develop/algebird-core/src/main/scala/com/twitter/algebird/HyperLogLog.scala&quot;&gt;HyperLogLog.scala&lt;/a&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Scala&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Apache License 2.0&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;AddThis&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;&lt;a href=&quot;https://github.com/addthis/stream-lib&quot;&gt;Stream-Lib&lt;/a&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;&lt;a href=&quot;https://github.com/addthis/stream-lib/blob/master/src/main/java/com/clearspring/analytics/stream/cardinality/HyperLogLog.java&quot;&gt;HyperLogLog.java&lt;/a&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Java&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Apache License 2.0&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;indie!&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;&lt;a href=&quot;https://gist.github.com/yukim&quot;&gt;yukim’s gists&lt;/a&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;&lt;a href=&quot;https://gist.github.com/yukim/2597943#file-hyperloglog-java&quot;&gt;HyperLogLog.java&lt;/a&gt;&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Java&lt;/td&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Apache License 2.0&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;&lt;p style='text-align: center;'&gt;Table 2. Available HyperLogLog implementations&lt;/p&gt;
&lt;p&gt;We chose &lt;a href=&quot;http://www.addthis.com/&quot;&gt;AddThis&lt;/a&gt;’s &lt;a href=&quot;https://github.com/addthis/stream-lib&quot;&gt;Stream-Lib&lt;/a&gt;’s implementation, as from my subjective point of view it seemed to be most clear, nicely documented and reasonably implemented; besides, they added a bunch of other sweet things for cardinality estimation in that same library, together with the list of papers their implementations were based upon.&lt;/p&gt;

&lt;h2 id=&quot;creating_offers&quot;&gt;Creating offers&lt;/h2&gt;

&lt;p&gt;There are two approaches to merging HyperLogLog values:&lt;/p&gt;

&lt;ol&gt;
&lt;li&gt;Either you create an object wrapping up each value in a HyperLogLog value and merge those after&lt;/li&gt;

&lt;li&gt;Or you create HyperLogLog value once for a set of values and then &lt;em&gt;offer&lt;/em&gt; them to this particular object&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Depending on the case, you might even want to construct an &lt;em&gt;offer&lt;/em&gt; string for your HyperLogLog value as composite key of multiple values in the row. But no matter what you do, keep in mind — it is way better and much more efficient to keep the offers and merge those into the existing HyperLogLog value, rather than merging multiple HyperLogLog values.&lt;/p&gt;

&lt;p&gt;Lets drop a little code sketch real quick to compare them:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='clojure'&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kd'&gt;ns &lt;/span&gt;&lt;span class='nv'&gt;...&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:import&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;com.clearspring.analytics.stream.cardinality&lt;/span&gt; &lt;span class='nv'&gt;HyperLogLog&lt;/span&gt; &lt;span class='nv'&gt;HyperLogLog$Builder&lt;/span&gt;&lt;span class='p'&gt;]))&lt;/span&gt;

&lt;span class='c1'&gt;;; single hyperloglog value, multiple inserts&lt;/span&gt;
&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;time&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;dotimes &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;n&lt;/span&gt; &lt;span class='mi'&gt;1000000&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
    &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;.offer&lt;/span&gt; &lt;span class='nv'&gt;h&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;str &lt;/span&gt;&lt;span class='s'&gt;&amp;quot;check&amp;quot;&lt;/span&gt; &lt;span class='nv'&gt;n&lt;/span&gt;&lt;span class='p'&gt;))))&lt;/span&gt;

&lt;span class='c1'&gt;;; and this is like if we are merging hyperloglogs all the time;&lt;/span&gt;
&lt;span class='c1'&gt;;; note that we have to create hyperloglog value every time&lt;/span&gt;
&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;time&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;dotimes &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;n&lt;/span&gt; &lt;span class='mi'&gt;1000000&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
    &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;merge &lt;/span&gt;&lt;span class='nv'&gt;h&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='k'&gt;let &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;nh&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;create&lt;/span&gt;&lt;span class='p'&gt;)]&lt;/span&gt;
      &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;.offer&lt;/span&gt; &lt;span class='nv'&gt;nh&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;str &lt;/span&gt;&lt;span class='s'&gt;&amp;quot;check&amp;quot;&lt;/span&gt; &lt;span class='nv'&gt;n&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
      &lt;span class='nv'&gt;nh&lt;/span&gt;&lt;span class='p'&gt;))))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here is a sample time comparison &lt;code&gt;offer&lt;/code&gt; vs &lt;code&gt;merge&lt;/code&gt; result:&lt;/p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;operation&lt;/th&gt;&lt;th&gt;execution 1&lt;/th&gt;&lt;th&gt;execution 2&lt;/th&gt;&lt;th&gt;execution 3&lt;/th&gt;&lt;th&gt;execution 4&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td style=&quot;text-align: center;&quot;&gt;&lt;code&gt;offer&lt;/code&gt;&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1513.87 msecs&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1479.377 msecs&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1493.119 msecs&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1485.23 msecs&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: center;&quot;&gt;&lt;code&gt;merge&lt;/code&gt;&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;7433.302 msecs&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;7306.165 msecs&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;7369.459 msecs&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;7246.366 msecs&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;&lt;p style='text-align: center;'&gt;Table 3. HyperLogLog offer vs merge execution times&lt;/p&gt;&lt;div class='note'&gt;Store list of raw distinct values and offer them to a single HyperLogLog object instead of merging separate HyperLogLog values, when possible.&lt;/div&gt;
&lt;h2 id=&quot;reducing&quot;&gt;Reducing&lt;/h2&gt;

&lt;p&gt;Now, once we have read files, reducing in Cascalog is rather easy and straightforward, yet we will throw in some code in order to deal with HyperLogLog values in an easy way:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='clojure'&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kd'&gt;defprotocol &lt;/span&gt;&lt;span class='nv'&gt;IHyperLogLogMerge&lt;/span&gt; 
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;hyperloglog-val&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;this&lt;/span&gt;&lt;span class='p'&gt;])&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;merge &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;this&lt;/span&gt; &lt;span class='nv'&gt;other&lt;/span&gt;&lt;span class='p'&gt;])&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;merge-with-hyperloglog&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;this&lt;/span&gt; &lt;span class='nv'&gt;other-hll&lt;/span&gt;&lt;span class='p'&gt;]))&lt;/span&gt;
 
&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;extend-protocol&lt;/span&gt; &lt;span class='nv'&gt;IHyperLogLogMerge&lt;/span&gt;
  &lt;span class='nv'&gt;nil&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;hyperloglog-val&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;this&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='nv'&gt;nil&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;merge-with-hyperloglog&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;this&lt;/span&gt; &lt;span class='nv'&gt;other-hll&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='nv'&gt;other-hll&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;merge &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;this&lt;/span&gt; &lt;span class='nv'&gt;other&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='nv'&gt;other&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
 
  &lt;span class='nv'&gt;Object&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;hyperloglog-val&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;this&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;doto &lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;create&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;.offer&lt;/span&gt; &lt;span class='nv'&gt;this&lt;/span&gt;&lt;span class='p'&gt;)))&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;merge-with-hyperloglog&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;this&lt;/span&gt; &lt;span class='nv'&gt;other-hll&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;.offer&lt;/span&gt; &lt;span class='nv'&gt;other-hll&lt;/span&gt; &lt;span class='nv'&gt;this&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='nv'&gt;other-hll&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;merge &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;this&lt;/span&gt; &lt;span class='nv'&gt;other&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
    &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;merge &lt;/span&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;hyperloglog-val&lt;/span&gt; &lt;span class='nv'&gt;other&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='nv'&gt;this&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
 
  &lt;span class='nv'&gt;HyperLogLog&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;hyperloglog-val&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;this&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='nv'&gt;this&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;merge-with-hyperloglog&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;this&lt;/span&gt; &lt;span class='nv'&gt;other-hll&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;.addAll&lt;/span&gt; &lt;span class='nv'&gt;this&lt;/span&gt; &lt;span class='nv'&gt;other-hll&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='nv'&gt;this&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;merge &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;this&lt;/span&gt; &lt;span class='nv'&gt;other&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
    &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;merge-with-hyperloglog&lt;/span&gt; &lt;span class='nv'&gt;other&lt;/span&gt; &lt;span class='nv'&gt;this&lt;/span&gt;&lt;span class='p'&gt;)))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As you can see, this will merge whatever you feed it, and provide you with the HyperLogLog value. Though, not used in this particular example, will be used extensively in reallife scenario, when aggregating already obtainded aggregated results (that will hold not offers, but HyperLogLog values).&lt;/p&gt;

&lt;p&gt;And then finally, let’s throw in some glue to aggregate HyperLogLog values in the Cascalog queries:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='clojure'&gt;&lt;span class='lineno'&gt;1&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;c/defaggregateop&lt;/span&gt; &lt;span class='nv'&gt;sum*&lt;/span&gt;
&lt;span class='lineno'&gt;2&lt;/span&gt;   &lt;span class='p'&gt;([]&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;create&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
&lt;span class='lineno'&gt;3&lt;/span&gt;   &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='nv'&gt;state&lt;/span&gt; &lt;span class='nv'&gt;val&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
&lt;span class='lineno'&gt;4&lt;/span&gt;     &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;.offer&lt;/span&gt; &lt;span class='nv'&gt;state&lt;/span&gt; &lt;span class='nv'&gt;val&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='lineno'&gt;5&lt;/span&gt;     &lt;span class='nv'&gt;state&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='lineno'&gt;6&lt;/span&gt;   &lt;span class='p'&gt;([&lt;/span&gt;&lt;span class='nv'&gt;state&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;state&lt;/span&gt;&lt;span class='p'&gt;]))&lt;/span&gt;
&lt;span class='lineno'&gt;7&lt;/span&gt;   
&lt;span class='lineno'&gt;8&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='k'&gt;def &lt;/span&gt;&lt;span class='nv'&gt;sum&lt;/span&gt;
&lt;span class='lineno'&gt;9&lt;/span&gt;   &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;ops/each&lt;/span&gt; &lt;span class='nv'&gt;sum*&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This operations will &lt;em&gt;“sum up”&lt;/em&gt; all the offers, the same way you would’ve use &lt;code&gt;cascalog.ops/sum&lt;/code&gt; operation on numerical values, you can use this operation on HyperLogLog values. In a cascalog query it will end up simply as:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='clojure'&gt;&lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;c/&amp;lt;-&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;?city&lt;/span&gt; &lt;span class='nv'&gt;?district&lt;/span&gt; &lt;span class='nv'&gt;?hll&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;ov-source&lt;/span&gt; &lt;span class='ss'&gt;:&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class='nv'&gt;ov-fields&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
  &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;hll/sum&lt;/span&gt; &lt;span class='nv'&gt;?uuid&lt;/span&gt; &lt;span class='ss'&gt;:&amp;gt;&lt;/span&gt; &lt;span class='nv'&gt;?hll&lt;/span&gt;&lt;span class='p'&gt;))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h2 id=&quot;persistent&quot;&gt;Persistent&lt;/h2&gt;

&lt;p&gt;HyperLogLog is an object, basically a set or register set’s under the hood, and might you want to persist it — you will require to serialize it somehow.&lt;/p&gt;

&lt;p&gt;Now in order to use some sort of Tap, you’ll need to store your bytes sequence, which in case of Cascalog is in a form of string of some kind; since at the moment we use both JDBC Taps and plain CSV files, without diving too deep, we simply encode it with &lt;code&gt;base64&lt;/code&gt; and throw it is as an UTF-8 string; so the whole cascalog query will look like this:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='clojure'&gt;&lt;span class='lineno'&gt; 1&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;c/defmapop&lt;/span&gt; &lt;span class='nv'&gt;stringify&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;hll-object&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
&lt;span class='lineno'&gt; 2&lt;/span&gt;   &lt;span class='p'&gt;[(&lt;/span&gt;&lt;span class='nf'&gt;Base64/encodeBase64String&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;.getBytes&lt;/span&gt; &lt;span class='nv'&gt;hll-object&lt;/span&gt;&lt;span class='p'&gt;))])&lt;/span&gt;
&lt;span class='lineno'&gt; 3&lt;/span&gt; 
&lt;span class='lineno'&gt; 4&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kd'&gt;defn &lt;/span&gt;&lt;span class='nv'&gt;get-day-n-year&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;epoch-time&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
&lt;span class='lineno'&gt; 5&lt;/span&gt;   &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='k'&gt;let &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt; &lt;span class='nv'&gt;epoch-time-long&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;Long/parseLong&lt;/span&gt; &lt;span class='nv'&gt;epoch-time&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='lineno'&gt; 6&lt;/span&gt;          &lt;span class='nv'&gt;in-millis&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nb'&gt;* &lt;/span&gt;&lt;span class='nv'&gt;epoch-time-long&lt;/span&gt; &lt;span class='mi'&gt;1000&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='lineno'&gt; 7&lt;/span&gt;          &lt;span class='nv'&gt;date&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;time2/from-long&lt;/span&gt; &lt;span class='nv'&gt;in-millis&lt;/span&gt;&lt;span class='p'&gt;)]&lt;/span&gt;
&lt;span class='lineno'&gt; 8&lt;/span&gt;     &lt;span class='p'&gt;[(&lt;/span&gt;&lt;span class='nf'&gt;.getDayOfYear&lt;/span&gt; &lt;span class='nv'&gt;date&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;.getYear&lt;/span&gt; &lt;span class='nv'&gt;date&lt;/span&gt;&lt;span class='p'&gt;)]))&lt;/span&gt;
&lt;span class='lineno'&gt; 9&lt;/span&gt; 
&lt;span class='lineno'&gt;10&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='kd'&gt;defn &lt;/span&gt;&lt;span class='nv'&gt;count-gvb-passengers&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;path&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
&lt;span class='lineno'&gt;11&lt;/span&gt;   &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='k'&gt;let &lt;/span&gt;&lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;ov-source&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;ov-source&lt;/span&gt; &lt;span class='nv'&gt;path&lt;/span&gt;&lt;span class='p'&gt;)]&lt;/span&gt;
&lt;span class='lineno'&gt;12&lt;/span&gt;     &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;c/&amp;lt;-&lt;/span&gt; &lt;span class='p'&gt;[&lt;/span&gt;&lt;span class='nv'&gt;?city&lt;/span&gt; &lt;span class='nv'&gt;?district&lt;/span&gt; &lt;span class='nv'&gt;?day&lt;/span&gt; &lt;span class='nv'&gt;?year&lt;/span&gt; &lt;span class='nv'&gt;?cardinality&lt;/span&gt; &lt;span class='nv'&gt;?base64-hll&lt;/span&gt;&lt;span class='p'&gt;]&lt;/span&gt;
&lt;span class='lineno'&gt;13&lt;/span&gt; 
&lt;span class='lineno'&gt;14&lt;/span&gt;       &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='ss'&gt;:trap&lt;/span&gt; &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;c/hfs-textline&lt;/span&gt; &lt;span class='s'&gt;&amp;quot;/tmp/hll-demo-errors&amp;quot;&lt;/span&gt; &lt;span class='ss'&gt;:sinkmode&lt;/span&gt; &lt;span class='ss'&gt;:replace&lt;/span&gt; &lt;span class='p'&gt;))&lt;/span&gt;
&lt;span class='lineno'&gt;15&lt;/span&gt; 
&lt;span class='lineno'&gt;16&lt;/span&gt;       &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;ov-source&lt;/span&gt; &lt;span class='ss'&gt;:&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class='nv'&gt;ov-fields&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='lineno'&gt;17&lt;/span&gt; 
&lt;span class='lineno'&gt;18&lt;/span&gt;       &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;hll/sum&lt;/span&gt; &lt;span class='nv'&gt;?uuid&lt;/span&gt; &lt;span class='ss'&gt;:&amp;gt;&lt;/span&gt; &lt;span class='nv'&gt;?hll&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='lineno'&gt;19&lt;/span&gt;       &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;cardinality&lt;/span&gt; &lt;span class='nv'&gt;?hll&lt;/span&gt; &lt;span class='ss'&gt;:&amp;gt;&lt;/span&gt; &lt;span class='nv'&gt;?cardinality&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='lineno'&gt;20&lt;/span&gt;       &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;get-day-n-year&lt;/span&gt; &lt;span class='nv'&gt;?timestamp&lt;/span&gt; &lt;span class='ss'&gt;:&amp;gt;&lt;/span&gt; &lt;span class='nv'&gt;?day&lt;/span&gt; &lt;span class='nv'&gt;?year&lt;/span&gt;&lt;span class='p'&gt;)&lt;/span&gt;
&lt;span class='lineno'&gt;21&lt;/span&gt;       &lt;span class='p'&gt;(&lt;/span&gt;&lt;span class='nf'&gt;hll/stringify&lt;/span&gt; &lt;span class='nv'&gt;?hll&lt;/span&gt; &lt;span class='ss'&gt;:&amp;gt;&lt;/span&gt; &lt;span class='nv'&gt;?base64-hll&lt;/span&gt;&lt;span class='p'&gt;))))&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Note that we throw in day and year parsing.&lt;/p&gt;

&lt;p&gt;Now we have nice rows grouped by &lt;code&gt;(district, day)&lt;/code&gt; key with the amount of passengers seen that day, which can be cheaply merged in the runtime (whenever you request statistics through any online tooling).&lt;/p&gt;

&lt;p&gt;Sweeet.&lt;/p&gt;

&lt;h1 id=&quot;gist&quot;&gt;Gist&lt;/h1&gt;

&lt;p&gt;And, of course, here is the full gist, of the code I used to demo HyperLogLog with Cascalog in this article; in order to run:&lt;/p&gt;
&lt;div class='highlight'&gt;&lt;pre&gt;&lt;code class='bash'&gt;  &lt;span class='nv'&gt;$ &lt;/span&gt;git clone https://gist.github.com/7319327.git
  &lt;span class='nv'&gt;$ &lt;/span&gt;&lt;span class='nb'&gt;cd cd&lt;/span&gt; ./7319327/
  &lt;span class='nv'&gt;$ &lt;/span&gt;lein demo ./ov-chipkaart-accesslogs.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It will produce output like:&lt;/p&gt;
&lt;table&gt;&lt;thead&gt;&lt;tr&gt;&lt;th&gt;?city&lt;/th&gt;&lt;th&gt;?district&lt;/th&gt;&lt;th&gt;?day&lt;/th&gt;&lt;th&gt;?year&lt;/th&gt;&lt;th&gt;?cardinality&lt;/th&gt;&lt;/tr&gt;&lt;/thead&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Amsterdam&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;6427&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;327&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;2012&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Amsterdam&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;6427&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;328&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;2012&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;3&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Delft&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;2290&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;53&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;2013&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Delft&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;3855&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;109&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;2013&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Delft&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;4091&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;74&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;2013&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Delft&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;5589&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;200&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;2013&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Den-Haag&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;3797&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;300&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;2013&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Edam&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;3886&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;47&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;2013&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Edam&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;5594&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;272&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;2013&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Haarlem&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1134&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;108&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;2013&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td style=&quot;text-align: left;&quot;&gt;Haarlem&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;4584&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;220&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;2013&lt;/td&gt;&lt;td style=&quot;text-align: center;&quot;&gt;1&lt;/td&gt;&lt;/tr&gt;
&lt;/tbody&gt;&lt;/table&gt;&lt;p style='text-align: center;'&gt;Table 4. Demo output&lt;/p&gt;&lt;script src='https://gist.github.com/7319327.js'&gt;&lt;![CDATA[ ]]&gt;&lt;/script&gt;
&lt;h1 id=&quot;links&quot;&gt;Links&lt;/h1&gt;

&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;http://clojure.org/&quot;&gt;Clojure: Dynamic programming language that target Java Virtual Machine&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href=&quot;http://blog.aggregateknowledge.com/2012/10/25/sketch-of-the-day-hyperloglog-cornerstone-of-a-big-data-infrastructure/&quot;&gt;HyperLogLog — Cornerstone of a Big Data Infrastructure&lt;/a&gt;&lt;/li&gt;

&lt;li&gt;&lt;a href=&quot;https://github.com/nathanmarz/cascalog&quot;&gt;Cascalog: Data processing on Hadoop without the hassle&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;&lt;em&gt;[Originally published in &lt;a href=&quot;http://screen6.github.io/blog/2013/11/13/hyperloglog-with-cascalog.html&quot;&gt;Screen6 Technical Blog&lt;/a&gt; on 20/25/2013]&lt;/em&gt;&lt;/p&gt;
</content>
 </entry>
 
 
</feed>
